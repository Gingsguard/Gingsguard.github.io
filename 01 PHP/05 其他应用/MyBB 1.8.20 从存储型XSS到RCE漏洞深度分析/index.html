<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		MyBB 1.8.20 从存储型XSS到RCE漏洞深度分析 | 
	 
	熊本熊本熊&#39;s Studio.
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	
  

	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">


	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>

	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

	
	
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
	<header id="header">
    <a id="title" href="/" class="logo">熊本熊本熊's Studio.</a>

	<ul id="menu">
		<li class="menu-item">
			<a href="/about" class="menu-item-link">ABOUT</a>
		</li>
		
		<li class="menu-item">
			<a href="https://github.com/wujun234/uid-generator-spring-boot-starter" class="menu-item-link" target="_blank">
				UidGenerator
			</a>
		</li>
		<li class="menu-item">
			<a href="https://github.com/wujun234" class="menu-item-link" target="_blank">
				<i class="fa fa-github fa-2x"></i>
			</a>
		</li>
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="text" placeholder="search...">
		<div id="tree">
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										01 PHP
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										01 Wordpress
									</a>
									
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/WordPress%205.0.0%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E(CVE-2019-8942&CVE-2019-8943)/">
										WordPress 5.0.0 远程代码执行漏洞(CVE-2019-8942&CVE-2019-8943)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/WordPress%205.1%20CSRF%20to%20RCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										WordPress 5.1 CSRF to RCE 漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/WordPress%20REST%20API%20%E5%86%85%E5%AE%B9%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										WordPress REST API 内容注入漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/Wordpress%20%204.7.1%E7%94%A8%E6%88%B7%E5%90%8D%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E(CVE-2017-5487)/">
										Wordpress  4.7.1用户名枚举漏洞(CVE-2017-5487)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/Wordpress%205.2.3%20%E6%9C%AA%E6%8E%88%E6%9D%83%E9%A1%B5%E9%9D%A2%E6%9F%A5%E7%9C%8B%E6%BC%8F%E6%B4%9E(CVE-2019-17671)/">
										Wordpress 5.2.3 未授权页面查看漏洞(CVE-2019-17671)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5BWP%E6%8F%92%E4%BB%B6%5D%20Crelly%20Slider%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%B0RCE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										[WP插件] Crelly Slider从任意文件上传到RCE漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5BWP%E6%8F%92%E4%BB%B6%5D%20Display%20Widgets%E5%90%8E%E9%97%A8%E4%BA%8B%E4%BB%B6%E5%88%86%E6%9E%90/">
										[WP插件] Display Widgets后门事件分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5BWP%E6%8F%92%E4%BB%B6%5D%20Rank%20Math%20SEO%E4%BB%BB%E6%84%8F%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%AE%E6%94%B9%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										[WP插件] Rank Math SEO任意元数据修改漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5BWP%E6%8F%92%E4%BB%B6%5D%20Social-Warfare%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										[WP插件] Social-Warfare远程代码执行漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5BWP%E6%8F%92%E4%BB%B6%5D%20WooCommerce%203.6.4%20%E4%BB%8ECSRF%E5%88%B0RCE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										[WP插件] WooCommerce 3.6.4 从CSRF到RCE漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5BWP%E6%8F%92%E4%BB%B6%5D%20WordpPress%20ThemeREX%20Addons%E5%A4%9A%E5%A4%84%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										[WP插件] WordpPress ThemeREX Addons多处漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5BWP%E6%8F%92%E4%BB%B6%5D%20%E4%BB%8E%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84wordpress%E6%8F%92%E4%BB%B6%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8Bwordpress%E6%8F%92%E4%BB%B6%E5%8E%9F%E7%90%86/">
										[WP插件] 从一个简单的wordpress插件漏洞研究一下wordpress插件原理
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5B%E7%BF%BB%E8%AF%91%5D%20WordPress%20WP%20Statistics%E6%8F%92%E4%BB%B6%E5%AD%98%E5%82%A8%E5%9E%8BXSS%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										[翻译] WordPress WP Statistics插件存储型XSS漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5B%E7%BF%BB%E8%AF%91%5D%20%E6%B5%85%E6%9E%90WordPress%205.2.3%E5%AE%89%E5%85%A8%E6%9B%B4%E6%96%B0/">
										[翻译] 浅析WordPress 5.2.3安全更新
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/01%20Wordpress/%5B%E7%BF%BB%E8%AF%91%5D%20%E6%B5%85%E6%9E%90WordPress5.0%E5%AD%98%E5%82%A8%E5%9E%8BXSS%E6%BC%8F%E6%B4%9E/">
										[翻译] 浅析WordPress5.0存储型XSS漏洞
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										02 Thinkphp
									</a>
									
							<ul>
								<li class="file">
									<a href="/01%20PHP/02%20Thinkphp/ThinkPHP%205.0%20SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										ThinkPHP 5.0 SQL注入漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										03 Drupal
									</a>
									
							<ul>
								<li class="file">
									<a href="/01%20PHP/03%20Drupal/Drupal%20Core%20mail()%20%E5%87%BD%E6%95%B0%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E(SA-CORE-2018-006)/">
										Drupal Core mail() 函数代码注入漏洞(SA-CORE-2018-006)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/03%20Drupal/Drupal8%20(CVE-2017-6926)%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/">
										Drupal8 (CVE-2017-6926)漏洞详解
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/03%20Drupal/Drupal%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E(CVE-2018-7600)/">
										Drupal远程代码执行漏洞(CVE-2018-7600)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										04 Joomla
									</a>
									
							<ul>
								<li class="file">
									<a href="/01%20PHP/04%20Joomla/Joomla%E5%86%85%E6%A0%B8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E(CVE-2018-8045)/">
										Joomla内核SQL注入漏洞(CVE-2018-8045)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										05 其他应用
									</a>
									
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/Discuz-ML!-V3.X%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										Discuz-ML!-V3.X 远程代码执行漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/GetSimpleCMS-Unauthenticated%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										GetSimpleCMS-Unauthenticated 远程代码执行漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/IPS%20Community%20Suite%20PHP%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										IPS Community Suite PHP远程代码执行漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/MyBB%201.8.20%20%E4%BB%8E%E5%AD%98%E5%82%A8%E5%9E%8BXSS%E5%88%B0RCE%E6%BC%8F%E6%B4%9E%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/">
										MyBB 1.8.20 从存储型XSS到RCE漏洞深度分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/Nginx-PHP-FPM%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-EXP%E5%88%86%E6%9E%90/">
										Nginx-PHP-FPM远程命令执行漏洞-EXP分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/OkayCMS%202.3.4%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E(CVE-2019-16885)/">
										OkayCMS 2.3.4 反序列化漏洞(CVE-2019-16885)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/PHPMailer%20RCE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										PHPMailer RCE漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/SugarCRM%20RCE%E6%BC%8F%E6%B4%9E%E8%B7%9F%E8%B8%AA%E6%8A%A5%E5%91%8A/">
										SugarCRM RCE漏洞跟踪报告
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/Web%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E2%80%94%E2%80%94%E9%A1%BA%E7%93%9C%E6%91%B8%E8%97%A4/">
										Web漏洞分析之——顺瓜摸藤
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/YouPHPTube-Encoder%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E(CVE-2019-5127&CVE-2019-5128CVE-2019-5129)/">
										YouPHPTube-Encoder 远程代码执行漏洞(CVE-2019-5127&CVE-2019-5128CVE-2019-5129)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/nhttpd%20%E4%BB%8E%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E5%88%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(CVE-2019-16278)/">
										nhttpd 从目录穿越到远程代码执行漏洞分析(CVE-2019-16278)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/%E4%BB%8EFlexPaper%202.3.7%20%E5%AE%89%E5%85%A8%E6%9B%B4%E6%96%B0%E5%85%A5%E6%89%8B%E5%8F%8D%E6%8E%A8%E6%BC%8F%E6%B4%9E/">
										从FlexPaper 2.3.7 安全更新入手反推漏洞
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/%E4%BB%8E%E6%9F%90cmsV4.1.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E7%9C%8B%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E5%AE%89%E5%85%A8%E9%9A%90%E6%82%A3/">
										从某cmsV4.1.0 sql注入漏洞看程序开发安全隐患
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/%E4%BB%8E%E6%9F%90cmsV9.9%E5%9B%9B%E4%B8%AA%E6%BC%8F%E6%B4%9E%E7%9C%8B%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E5%AE%89%E5%85%A8/">
										从某cmsV9.9四个漏洞看程序开发安全
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/%E6%9F%90CMS%E5%90%8E%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
										某CMS后台远程代码执行漏洞
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/%E7%A9%BA%E5%AE%89%E5%85%A8%E6%84%8F%E8%AF%86%EF%BC%8C%E6%92%B8%E7%A0%81%E4%B8%80%E6%97%B6%E6%89%8B%E6%8A%96%20elFinder2.1.47%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E(CVE-2019-9194)%E8%AF%A6%E8%A7%A3/">
										空安全意识，撸码一时手抖 elFinder2.1.47代码执行漏洞(CVE-2019-9194)详解
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										02 Java
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										01 Struts2
									</a>
									
							<ul>
								<li class="file">
									<a href="/02%20Java/01%20Struts2/Struts2%20S2-001%E6%BC%8F%E6%B4%9E%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6/">
										Struts2 S2-001漏洞深入研究
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/02%20Java/01%20Struts2/Struts2%20S2-045%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										Struts2 S2-045漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/02%20Java/01%20Struts2/Struts2%20S2-046%E6%BC%8F%E6%B4%9E%E2%80%94%E2%80%94045%E7%9A%84%E5%90%8C%E5%88%86%E5%BC%82%E6%9E%84%E4%BD%93/">
										Struts2 S2-046漏洞——045的同分异构体
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/02%20Java/01%20Struts2/Struts2%20S2-052%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										Struts2 S2-052漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/02%20Java/01%20Struts2/Struts2%20mvc%20%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/">
										Struts2 mvc 框架分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/02%20Java/01%20Struts2/Struts2%E4%BB%8E%E8%AF%B7%E6%B1%82%E5%88%B0Action%E2%80%94%E2%80%94%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E7%A0%94%E7%A9%B6/">
										Struts2从请求到Action——反射机制研究
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										03 WebLogic
									</a>
									
							<ul>
								<li class="file">
									<a href="/02%20Java/03%20WebLogic/CVE-2017-10271/">
										CVE-2017-10271
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/02%20Java/03%20WebLogic/xmldecoder/">
										xmldecoder
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										03 Python
									</a>
									
							<ul>
								<li class="file">
									<a href="/03%20Python/DjangoUEditor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
										DjangoUEditor任意文件上传漏洞分析
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/03%20Python/Python%E4%B8%AD%E6%9C%89%E6%BD%9C%E5%9C%A8%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E9%A3%8E%E9%99%A9%E7%9A%84%E5%87%BD%E6%95%B0(%E4%B8%80)/">
										Python中有潜在代码执行风险的函数(一)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/03%20Python/Supervisord%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(CVE-2017-11610)/">
										Supervisord远程命令执行漏洞分析(CVE-2017-11610)
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/03%20Python/%5B%E7%BF%BB%E8%AF%91%5D%20%E4%BB%8EPebble%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">
										[翻译] 从Pebble看服务端模板注入漏洞
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										04 其他
									</a>
									
							<ul>
								<li class="file">
									<a href="/04%20%E5%85%B6%E4%BB%96/CVE-2019-1040/">
										CVE-2019-1040
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/04%20%E5%85%B6%E4%BB%96/Intigriti%2010k%20followers%20XSS%20challenge%E9%A2%98%E8%A7%A3/">
										Intigriti 10k followers XSS challenge题解
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/04%20%E5%85%B6%E4%BB%96/Webmin-RCE/">
										Webmin-RCE
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/04%20%E5%85%B6%E4%BB%96/github-enterprise-rce/">
										github-enterprise-rce
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/04%20%E5%85%B6%E4%BB%96/hexohelp/">
										hexohelp
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										05 杂文
									</a>
									
							<ul>
								<li class="file">
									<a href="/05%20%E6%9D%82%E6%96%87/2020%20,2020%EF%BC%81/">
										2020 ,2020！
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/05%20%E6%9D%82%E6%96%87/Hello-World-0/">
										Hello-World-0
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/05%20%E6%9D%82%E6%96%87/forfun/">
										forfun
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/05%20%E6%9D%82%E6%96%87/kris/">
										kris
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/05%20%E6%9D%82%E6%96%87/ukiyoe/">
										ukiyoe
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">

	MyBB 1.8.20 从存储型XSS到RCE漏洞深度分析
</h1>
<div class="article-meta">
	
	<span>熊本熊本熊</span>
	<span>2019-09-04 19:26:54</span>
    
		<div id="article-categories">
            
                
                    <span>
                        <i class="fa fa-folder" aria-hidden="true"></i>
                        <a href="/categories/技术/">技术</a>
						
                    </span>
                
            
		</div>
    
</div>

<div id="article-content">
	<div align="center"></div>

<p>MyBB是国际上非常优秀的免费论坛软件，最大的特色是简单但是功能却出奇的强大，支持多国语言，可以分别设置前台后台的语言。</p>
<p>MyBB作为一个开源项目，拥有活跃的社区环境，项目的管理,发展由社区志愿者支持。用户量广泛，在github上的项目拥有609 个star，79个releases。</p>
<p>MyBB &lt;= 1.8.20存在一处从存储的XSS到RCE组合利用漏洞，攻击者可以先通过xss获得管理员权限，再通过rce达到远程代码执行。这套利用流程不仅隐蔽而且利用难度低，只要私信给mybb管理员发出一条包含payload的消息即可。</p>
<a id="more"></a>

<p>该漏洞由RIPS 团队安全研究人员Simon Scannell发现并纰漏。但截止目前，并未公布利用poc</p>
<p>我们试图从Simon Scannell简单的漏洞披露中深入分析该漏洞，并尝试还原出poc</p>
<p>首先分析下mybb xss漏洞</p>
<p>&nbsp;</p>
<h2 id="0x01-XSS漏洞"><a href="#0x01-XSS漏洞" class="headerlink" title="0x01 XSS漏洞"></a><strong>0x01 XSS漏洞</strong></h2><hr>
<p>此漏洞为mybb对BBCode的错误解析而造成的</p>
<p>首先了解下BBCode:</p>
<p>BCode是Bulletin Board Code的缩写，属于轻量标记语言（Lightweight Markup Language）的一种，如字面上所表示的，它主要是使用在BBS、论坛、Blog等网络应用上。BBcode的语法通常为 [标记] 这种形式，即语法左右用两个中括号包围，以作为与正常文字间的区别。系统解译时遇上中括号便知道该处是BBcode，会在解译结果输出到用户端时转换成最为通用的HTML语法。</p>
<p>下图举个简单的例子：</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408424824_0.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408424824_0.png" alt="0"></a></p>
<p>在BBcode中给关键词加链接可以用下面的代码：</p>
<p>[url=<a target="_blank" rel="noopener" href="https://www.xiongbenxiongbenxiong.com/1.html">https://www.xiongbenxiongbenxiong.com/1.html</a>]熊本熊本熊[/url]</p>
<p>然而，BBcode只是一种标记语言，并没有一个共同的标准。各个BBS、论坛、Blog等网络应用程序可能会有自己独创的BBcode。在实际场景中，不同的程序会在后台使用不同的方式将BBcode解析成html来进行页面渲染</p>
<p>接下来看下mybb程序对BBCode的解析流程</p>
<p>举一个例子，使用BBcode格式分别插入的一条视频链接与一条url链接</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408425165_1.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408425165_1.png" alt="1"></a></p>
<p>Mybb程序会对BBcode进行解析，以便转化为浏览器可识别的html语言</p>
<p>Mybb首先会对video链接进行解析（注意：这与video和url的排列顺序无关，在程序的后台，会首先处理video，后处理url）</p>
<p>经过video解析器解析后的格式如下</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408425474_2.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408425474_2.png" alt="2"></a></p>
<p>接着mybb对BBCode格式的url进行解析，经过url解析器解析后的格式如下</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408425622_3.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408425622_3.png" alt="3"></a></p>
<p>此时，mybb以将BBcode语言解析成为html语言，浏览器渲染页面，显示嵌入的video与超链接中的url</p>
<p>如果，我们将两个BBCode格式的语句进行嵌套呢？</p>
<p>像如下图这样的形式</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/201909040842598_4.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/201909040842598_4.png" alt="4"></a></p>
<p>按照我们的推测，会进行如下的解析：</p>
<p>首先，解析video</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/20190904084302100_5.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/20190904084302100_5.png" alt="5"></a></p>
<p>解析之后的格式如上图</p>
<p>然后，解析url，也就是下图红框处的结构</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408430523_6.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408430523_6.png" alt="6"></a></p>
<p>解析之后的结果如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408430716_7.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408430716_7.png" alt="7"></a></p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408431056_8.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408431056_8.png" alt="8"></a></p>
<p>注意上图红框这里，src中的值，被href引入的双引号闭合，而onmusemove成功逃逸出来，意味着alert会在鼠标移动时，alert将会被执行</p>
<p>事实上，以上的流程，在mybb中是否成立。正式因为上文猜测中的嵌套解析，造成了此次xss漏洞</p>
<p>接下来跟下代码</p>
<p>首先，我们给管理员（admin）账号发一条如下图bbcode语言的私信</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408431490_9.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408431490_9.png" alt="9"></a></p>
<p>这条私信会原封不动的被写入数据库中</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408431789_10.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408431789_10.png" alt="10"></a></p>
<p>当管理员查看私信时，这条message会被从数据库中取出，并解析为html语言进行渲染</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408432090_11.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408432090_11.png" alt="11"></a></p>
<p>程序调用private.php执行上述操作，跟进private.php</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/201909040843246_12.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/201909040843246_12.png" alt="12"></a></p>
<p>在997行处，程序将留言从数据库中取出，并赋值$pm</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408432858_13.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408432858_13.png" alt="13"></a></p>
<p>在11789行处，将$pm传入build_postbit方法</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408433134_14.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408433134_14.png" alt="14"></a></p>
<p>跟入build_postbit方法</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408433443_15.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408433443_15.png" alt="15"></a></p>
<p>在该方法774行处，将message传入parse_message,这里的message即为我们构造的BBCode语句</p>
<p>跟入parse_message方法</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408434148_16.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408434148_16.png" alt="16"></a></p>
<p>在parse_message方法中201行处，调用parse_mycode对$message进行处理</p>
<p>跟入parse_mycod方法</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408434479_17.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408434479_17.png" alt="17"></a></p>
<p>如上图，第一个红框处，会对bbcode中的video结构进行解析，而第二个红框处，会对url,email等结构进行解析。正因为这里的解析的先后顺序，决定了构造poc时的嵌套顺序</p>
<p>首先来看video解析</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408434815_18.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408434815_18.png" alt="18"></a></p>
<p>这里使用了preg_replace_callback，对匹配到的内容使用mycode_parse_video_callback回调进行替换</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408435155_19.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408435155_19.png" alt="19"></a></p>
<p>跟入mycode_parse_video_callback</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408435498_20.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408435498_20.png" alt="20"></a></p>
<p>可见mycode_parse_video_callback将$matches[1], $matches[2]传入mycode_parse_video方法</p>
<p>跟入mycode_parse_video方法</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408435737_21.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408435737_21.png" alt="21"></a></p>
<p>如下图，首先使用parse_url对传入的url($matches[2])进行解析</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408440199_22.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408440199_22.png" alt="22"></a></p>
<p>解析后的parsed_url值如下图</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408440475_23.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408440475_23.png" alt="23"></a></p>
<p>接着，将$parsed_url[‘fragment’]赋值与$ fragment</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408440715_24.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408440715_24.png" alt="24"></a></p>
<p>随后，进入switch语句，根据不同视频来源，分情况解析。我们这里构造的是youtbe来源，进入该分支</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408441164_25.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408441164_25.png" alt="25"></a></p>
<p>在下图中，将$ fragment中的!v=置空，赋值与$id</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408441466_26.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408441466_26.png" alt="26"></a></p>
<p>此时id值为test[url=onmousemove=’alert(1337)’]</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408441887_27.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408441887_27.png" alt="27"></a></p>
<p>随后，由于担心xss攻击，程序在这里对$id进行html特殊字符转义处理，如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408442138_28.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408442138_28.png" alt="28"></a></p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408442429_29.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408442429_29.png" alt="29"></a></p>
<p>接着，从templates中取出对应video的模板，如下图$templates get方法</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408442779_30.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408442779_30.png" alt="30"></a></p>
<p>根据get方法，看下取出模板的形式</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/20190904084430100_31.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/20190904084430100_31.png" alt="31"></a></p>
<p>上图为最终生成html的模板，此处的$id即为上文中case分支中赋值的$id</p>
<p>最终，将$id值填充的模板中，结果如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408443348_32.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408443348_32.png" alt="32"></a></p>
<p>回到preg_replace_callback处，$message替换后的结果如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408443628_33.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408443628_33.png" alt="33"></a></p>
<p>此时$message=&lt;iframe width=”560” height=”315” src=”//<a target="_blank" rel="noopener" href="http://www.youtube.com/embed/test[url=onmousemove=&#39;alert(1337)&#39;]&quot;">www.youtube.com/embed/test[url=onmousemove=&#39;alert(1337)&#39;]&quot;</a> frameborder=”0” allowfullscreen&gt;&lt;/iframe&gt;[/url]</p>
<p>Video的解析到此结束了，此时html语句，是不是和上文流程中猜测的形式一样呢？</p>
<p>&nbsp;</p>
<p>接下来，仍然使用preg_replace_callback对url进行替换</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408443948_34.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408443948_34.png" alt="34"></a></p>
<p>如下图可见，使用#[url=((?!javascript)[a-z]+?://)([^</p>
<p>“&lt;]+?)](.+?)[/url]#si正则进行匹配，使用</p>
<p>mycode_parse_url_callback1回调对$message进行替换</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408444218_35.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408444218_35.png" alt="35"></a></p>
<p>此处的处理与上文中的video极其相似，这里就不重复说明了</p>
<p>在url解析结束后，messgae值如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408444522_36.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408444522_36.png" alt="36"></a></p>
<p>可见，如上文流程分析一致，href中引入的双引号，将src闭合了，onmousemove得以逃逸</p>
<p>最终，xss产生</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408444935_37.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408444935_37.png" alt="37"></a></p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408445217_38.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408445217_38.png" alt="38"></a></p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408445522_39.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408445522_39.png" alt="39"></a></p>
<p>利用给管理员私信的这个功能，通过xss漏洞，可以获取管理员cookie，从而获得后台权限</p>
<p>接下来分析下rce漏洞</p>
<p>&nbsp;</p>
<h2 id="0x02-RCE漏洞"><a href="#0x02-RCE漏洞" class="headerlink" title="0x02 RCE漏洞"></a><strong>0x02 RCE漏洞</strong></h2><hr>
<p>Mybb后台提供导入theme功能</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408445899_40.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408445899_40.png" alt="40"></a></p>
<p>可以选择本地theme进行导入，上传的theme格式许为xml格式，形式如下</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408450222_41.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408450222_41.png" alt="41"></a></p>
<p>这里的导入的xml文件存储了该theme下所有包含的css文件，下面展示其中两个片段</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408450698_42.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408450698_42.png" alt="42"></a></p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408450976_43.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408450976_43.png" alt="43"></a></p>
<p>简单来说，相当于是把这个theme里包含的所有css都存储到xml一个结构里</p>
<p>在上传xml格式的theme时，程序后台会解析该xml，如下图代码</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408451292_44.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408451292_44.png" alt="44"></a></p>
<p>随后，将解析的xml树中的内容，例如css名称，内容、id等写入数据库</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408451570_45.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408451570_45.png" alt="45"></a></p>
<p>上图即为解析上传的xml格式的theme，将解析出的css的信息入库的操作</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408451874_46.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408451874_46.png" alt="46"></a></p>
<p>入库后，数据库中内容如上图</p>
<p>在解析xml内的css数据的name时，后台程序会校验css的后缀是否合法</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408452251_47.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408452251_47.png" alt="47"></a></p>
<p>可见，程序要求xml结构中，css文件后缀应为.css。但其校验方式仅仅检测css名称后四位是否为.css</p>
<p>当我们构造css数据时，可以使得css文件名为aaaaaaaaaaaaaaaaaaaaaaaaaa.php.css,在css文件内容处插入payload，如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408452587_48.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408452587_48.png" alt="48"></a></p>
<p>在xml解析后，$stylesheet[‘attributes’][‘name’]的值为aaaaaaaaaaaaaaaaaaaaaaaaaa.php.css，成功绕过检测</p>
<p>当进行入库操作时，如下图代码</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408452876_49.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408452876_49.png" alt="49"></a></p>
<p>此时将要插入表中name字段的值为aaaaaaaaaaaaaaaaaaaaaaaaaa.php.css，由于mysql默认字段长度为30字符，而我们的name长度为34字符，所以，.css会被截断，最终插入表中name字段的值为aaaaaaaaaaaaaaaaaaaaaaaaaa.php。</p>
<p>与此同时，aaaaaaaaaaaaaaaaaaaaaaaaaa.php.css中的内容，会插入到stylesheet字段中，我们构造的payload随同aaaaaaaaaaaaaaaaaaaaaaaaaa.php.css中的内容，一同写入数据库。</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408453146_50.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408453146_50.png" alt="50"></a></p>
<p>程序在执行xml数据从解析到入库的操作的同时，也会在本地生成对应的文件，如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408453593_51.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408453593_51.png" alt="51"></a></p>
<p>这里生成文件名仍是.css后缀。原因很好理解：这里生成的文件名由解析上传的xml文件中的css name值决定的，如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408453755_52.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408453755_52.png" alt="52"></a></p>
<p>因此后缀为.css</p>
<p>&nbsp;</p>
<p>接下来在后台页面中，查看我们刚刚导入的theme</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408454088_53.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408454088_53.png" alt="53"></a></p>
<p>可以看到我们grq themes里的css列表中，后缀已经变为php</p>
<p>这是为什么呢？原因很简单，因为此处展示的内容，是从数据库中查询得到，此时数据库内容如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408454318_54.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408454318_54.png" alt="54"></a></p>
<p>数据库由于30字符最大长度的截断，已经把入库的文件名后的.css截断了，此时数据库中name的后缀变为php</p>
<p>这时，点击Stylesheets in grq 列表中的aaaaaaaaaaaaaaaaaaaaaaaaaa.php，进入编辑页面</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408454721_55.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408454721_55.png" alt="55"></a></p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408455075_56.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408455075_56.png" alt="56"></a></p>
<p>再次查看后台文件夹，可见生成了一个.php后缀文件，如下图</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/201909040845533_57.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/201909040845533_57.png" alt="57"></a></p>
<p>这里的原理也很简单。点击编辑css文件时，程序会从数据库中读取该文件的name以及内容，</p>
<p>并判断在指定目录中是否存在，若不存在，则用数据库中取出的name为文件名，生成文件，并将数据库中取出的内容写入该文件中</p>
<p>由于此时库中的name为aaaaaaaaaaaaaaaaaaaaaaaaaa.php，所以在指定位置生成了aaaaaaaaaaaaaaaaaaaaaaaaaa.php文件</p>
<p>下面跟下php文件生成的流程与代码</p>
<p>在点击aaaaaaaaaaaaaaaaaaaaaaaaaa.php，进入其编辑页面这个操作</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408455691_58.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408455691_58.png" alt="58"></a></p>
<p>&nbsp;</p>
<p>此时发送请求如下</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408455935_59.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408455935_59.png" alt="59"></a></p>
<p>后台代码执行如下：</p>
<p>首先进入</p>
<p>\admin\modules\style\themes.php</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408460279_60.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408460279_60.png" alt="60"></a></p>
<p>此时的action为edit_stylesheet，进入上图分支</p>
<p>接着从数据库中查询该条数据，执行的sql语句如下</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408460538_61.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408460538_61.png" alt="61"></a></p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/201909040846089_62.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/201909040846089_62.png" alt="62"></a></p>
<p>查询结果如上图</p>
<p>&nbsp;</p>
<p>最后将库中内容写入文件，文件名即为库中name字段，文件内容即为库中stylesheet字段</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408461176_63.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408461176_63.png" alt="63"></a></p>
<p>如上图，构造的payload被写入aaaaaaaaaaaaaaaaaaaaaaaaaa.php</p>
<p>&nbsp;</p>
<p>打开aaaaaaaaaaaaaaaaaaaaaaaaaa.php，可见payload成功写入</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408461455_64.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408461455_64.png" alt="64"></a></p>
<p>&nbsp;</p>
<p>访问该文件</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408461889_65.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408461889_65.png" alt="65"></a></p>
<p>Phpinfo执行成功</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="0x03-漏洞分析时发现的问题"><a href="#0x03-漏洞分析时发现的问题" class="headerlink" title="0x03 漏洞分析时发现的问题"></a><strong>0x03 漏洞分析时发现的问题</strong></h2><hr>
<h3 id="1-sql-mode默认值问题"><a href="#1-sql-mode默认值问题" class="headerlink" title="1. sql_mode默认值问题"></a><strong>1. sql_mode默认值问题</strong></h3><p>笔者在尝试构造与复现rce漏洞时，当构造34字符长度文件名，以便通过mysql最大长度截断机制截断时，出现的如下问题：</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408462238_66.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408462238_66.png" alt="66"></a></p>
<p>Data too long~</p>
<p>笔者使用的是Wamp环境，在查看安装的mysql配置时，发现默认sql_mode为STRICT_ALL_TABLES，如下图：</p>
<p><a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408462511_67.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408462511_67.png" alt="67"></a></p>
<p>STRICT_ALL_TABLES：</p>
<p>对所有引擎的表都启用严格模式。(STRICT_TRANS_TABLES只对支持事务的表启用严格模式)。</p>
<p>在严格模式下，一旦任何操作的数据产生问题，都会终止当前的操作。对于启用STRICT_ALL_TABLES选项的非事务引擎来说，这时数据可能停留在一个未知的状态。这可能不是所有非事务引擎愿意看到的一种情况，因此需要非常小心这个选项可能带来的潜在影响。</p>
<p>在严格模式下，超长的字符串，不能被截断入库，因此这里可能会影响到该漏洞的利用</p>
<p>###</p>
<h3 id="2-urldecode的必要性"><a href="#2-urldecode的必要性" class="headerlink" title="2.urldecode的必要性"></a>2.urldecode的必要性</h3><p>在xss漏洞中，漏洞作者原文有一段描述如下</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408462865_68.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408462865_68.png" alt="68"></a></p>
<p>漏洞作者在他的文章中这样描述</p>
<p>“通常，由于正则表达式过滤器可以防止此类攻击，因此无法在其他bbcodes中注入bbcodes。但是，对于呈现[video] bbcodes的回调方法会在应嵌入的视频的URL上调用urldecode（）。视频URL被urldecoded，这将允许绕过正则表达式保护并通过URL编码注入。”</p>
<p>从作者的描述来看，正是因为此处的urldecode存在，导致被url编码后的payload可以绕过正则防护，从而造成注入。根据作者描述，构建的流程如下：</p>
<p>1.Payload-&gt;正则过滤器-&gt;检测不通过-&gt;失败</p>
<p>2.url编码后的payload-&gt;正则过滤器-&gt;检测通过-&gt;urldecode-&gt;还原为明文payload-&gt;注入成功</p>
<p>但是在我实际分析中，发现根本不需要对payload进行URL编码，正如上文我构造的pyaload，无需编码仍可触发漏洞。而且，也没有在urldecode执行前，发现正则过滤器</p>
<h3 id="3-RCE漏洞的入口"><a href="#3-RCE漏洞的入口" class="headerlink" title="3.RCE漏洞的入口"></a>3.RCE漏洞的入口</h3><p>关于RCE漏洞的入口，作者原文描述如下:</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408463197_69.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408463197_69.png" alt="69"></a></p>
<p>在此处，作者多次提到create与choose the filename字眼，一度让我认为漏洞存在于创建与修改Theme处，如下图</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408463671_70.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408463671_70.png" alt="70"></a></p>
<p>或是修改Template Name处，如下图</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408463921_71.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408463921_71.png" alt="71"></a></p>
<p>在尝试寻找rce入口时，发现一处有意思的地方，当修改templates为aaaaaaaaaaaaaaaaaaaaaaaaaa.php.css时</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408464218_72.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408464218_72.png" alt="72"></a></p>
<p>保存后，程序会将.css截断，并提示后缀问题，如下图</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408464587_73.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408464587_73.png" alt="73"></a></p>
<p>在跟踪此处代码时发现，在修改template name时，程序是会检查文件名长度并截断的，控制template name长度为30字符，如下图</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408464861_74.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408464861_74.png" alt="74"></a></p>
<p>这里可以印证，漏洞入口并不在修改名字和创建template处，经过后来的分析与寻找，才找到上文中真正的入口点，也就是Import a Theme处。但是从这个过程可见，mybb对文件名长度还是有一定限制的，只是防护的有疏漏，忘记检查导入的xml结构中的name字段长度。</p>
<p>&nbsp;</p>
<h2 id="0x04-漏洞修复"><a href="#0x04-漏洞修复" class="headerlink" title="0x04 漏洞修复"></a><strong>0x04 漏洞修复</strong></h2><hr>
<h3 id="xss漏洞"><a href="#xss漏洞" class="headerlink" title="xss漏洞"></a><strong>xss漏洞</strong></h3><p>针对xss漏洞，使用encode_url方法替换原来的htmlspecialchars_uni，如下图</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408465133_75.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408465133_75.png" alt="75"></a></p>
<p>回顾上文，在漏洞利用中，id中的内容为嵌套的url bbcod代码</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408465356_76.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408465356_76.png" alt="76"></a></p>
<p>当id被url编码后，之后在通过正则解析url bbcod代码时，该处被编码后的内容就不会被正则匹配到，从而防止嵌套解析造成xss漏洞</p>
<h3 id="RCE漏洞"><a href="#RCE漏洞" class="headerlink" title="RCE漏洞"></a>RCE漏洞</h3><p>针对rce漏洞，使用my_substr方法限制name长度为30字符，如下图</p>
<p> <a target="_blank" rel="noopener" href="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408465669_77.png"><img src="http://alphalab1-wordpress.stor.sinaapp.com/uploads/2019/09/2019090408465669_77.png" alt="77"></a></p>

</div>


    <div class="post-guide">
        <div class="item left">
            
              <a href="/01%20PHP/05%20%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8/%E4%BB%8E%E6%9F%90cmsV4.1.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E7%9C%8B%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E5%AE%89%E5%85%A8%E9%9A%90%E6%82%A3/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  从某cmsV4.1.0 sql注入漏洞看程序开发安全隐患
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/04%20%E5%85%B6%E4%BB%96/Webmin-RCE/">
                
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>



	<div id="vcomments"></div>


<script>
	
		// 评论
		new Valine({
			av: AV,
			el: '#vcomments',
			notify: false,
			verify: false,
			path: window.location.pathname,
			appId: '',
			appKey: '',
			placeholder: '请输入评论',
			avatar: 'retro',
			recordIP: false
		})
	
	
</script>
	</div>
	<div id="footer">
	<p>
	©2019-<span id="footerYear"></span> 
	<a href="/">熊本熊本熊</a> 
	
	
		|
		<span id="busuanzi_container_site_pv">
			pv
			<span id="busuanzi_value_site_pv"></span>
		</span>
		|
		<span id="busuanzi_container_site_uv"> 
			uv
			<span id="busuanzi_value_site_uv"></span>
		</span>
	
	<br>
	Theme <a href="//github.com/wujun234/hexo-theme-tree" target="_blank">Tree</a>
	by <a href="//github.com/wujun234" target="_blank">WuJun</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>
<script type="text/javascript"> 
	document.getElementById('footerYear').innerHTML = new Date().getFullYear() + '';
</script>
	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>